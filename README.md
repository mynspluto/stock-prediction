# 주식 가격 예측 파이프라인

## 개요

과거 주식 가격을 바탕으로 미래의 주식 가격을 예측하는 파이프라인을 구축했습니다

## 목적

데이터 엔지니어링의 핵심 요소인 ETL 파이프라인 구축과 모델 학습을 구현하기 위해서입니다

데이터의 사이즈와 기능에 비해 오버 엔지니어링이라는 생각도 들었습니다

다만 방대한 양의 데이터를 구하고 이를 처리하기 위한 컴퓨팅 파워를 마련하기는 쉽지 않을 듯하여

대략 16,000 row(1980년 부터의 일간 나스닥 데이터)의 데이터를 처리하는 정도의 사이즈로 프로젝트를 마쳤습니다

## 기술 스택

Airflow, Hadoop, Kafka, Kubernetes(Minikube), Docker, Next, FastAPI

## 주요 기능

- 파이프라인(ETL + ML)
  - 야후 파이낸스 API를 사용해 주식 가격 데이터 수집
  - 수집된 데이터를 YYYY-MM(년-월) 단위로 파싱하여 파일 적재
  - 적재된 파일을 맵리듀스하여 모델 학습
  - 모델 저장
- 주가 예측 API
  - 사용자가 웹에 들어와 페이지 로드 하는 경우 주가 예측 API가 요청됩니다
  - 저장된 모델로 다음 영업일의 주가 예측
  - 현재 장이 시작된 경우 예측했던 주가와 오차가 크면 메시지 전송하여 로그 생성
- 자동 배포
  - Github Action을 사용하여 자동 배포를 구성하였습니다
  - Kubernetes Rolling을 통해 무중단으로 운영 중입니다

## 시스템 구성도

![시스템 구성도](./system_diagram.svg)

## 마주했던 이슈

- 단일 노드 환경에서 쿠버네티스를 사용하기 위해 사용한 minikube와 호스트의 docker image 싱크가 안 맞는 이슈

  - 상황
    - 도커 빌드 후 minikube에서 이를 pod의 image로 사용하려고 하면 image를 찾지 못 하는 이슈가 있었습니다
  - 해결
    - eval $(minikube -p minikube docker-env)로 호스트와 minikube의 도커 간의 싱크를 맞춰 해결했습니다

- ec2를 재시작 하거나 하둡을 재시작 한 경우 하둡의 네임노드가 켜지지 않는 이슈

  - 상황
    - 하둡 재기동시, 이미 네임노드를 format 했었지만 다시 네임노드를 format을 해야지만 정상 작동 되는 이슈가 있었습니다
    - 네임노드와, 데이터노드에 쌓이는 데이터가 /tmp 디렉토리 밑에 쌓여 /tmp 밑의 데이터가 ec2 재시작 등의 이유로 사라지게 되면 재 시작시 네임노드 metadata, 데이터노드의 data가 사라져 접근이 안 되는 것이 원인이었습니다
  - 해결
    - hdfs-site.xml에서 네임노드와 데이터노드의 데이터를 저장하는 위치를 지정하여 해결했습니다

- 카프카가 실행되지 않는 이슈
  - 상황
    - 에어플로우, 하둡은 실행이 되는데 하둡이 실행되지 않는 이슈가 있었습니다
    - 카프카를 먼저 키고 에어플로우나 하둡을 실행하는 경우는 정상적으로 기동 되었습니다
    - 자원 사용량을 모니터링 한 결과 메모리가 부족하여 발생하는 이슈였습니다
  - 해결
    - minikube 실행시 메모리 할당량을 늘려 해결했습니다
